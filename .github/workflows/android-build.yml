name: Android Build

on:
  push:
    branches: ['*']
  pull_request:
    branches: ['*']
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-enabled: true

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Build Debug APK
        run: ./gradlew --no-daemon assembleDebug

      - name: Find APK files
        id: find-apk
        run: |
          APK_PATH=$(find . -path "**/build/outputs/apk/debug/*.apk" -type f | head -1)
          if [ -z "$APK_PATH" ]; then
            echo "::error::APK not found! Listing build directory:"
            find . -path "*/build/outputs*" -type f 2>/dev/null || echo "No build/outputs found"
            ls -R app/build/outputs 2>/dev/null || echo "app/build/outputs not found"
            exit 1
          fi
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
          echo "Found APK: $APK_PATH"

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: "**/build/outputs/apk/debug/*.apk"
          if-no-files-found: error

      - name: Clean up - Reset to template
        if: success() && github.event_name == 'push'
        run: |
          # 配置 git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # 恢复 app/src 为最小 demo
          rm -rf app/src
          mkdir -p app/src/main/java/com/example/demo
          mkdir -p app/src/main/res/layout
          mkdir -p app/src/main/res/values

          # 写入最小 demo 文件
          cat > app/src/main/AndroidManifest.xml << 'MANIFEST'
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">
              <application
                  android:allowBackup="true"
                  android:icon="@android:drawable/ic_menu_compass"
                  android:label="@string/app_name"
                  android:theme="@style/Theme.Material3.Light.NoActionBar">
                  <activity android:name=".MainActivity" android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
              </application>
          </manifest>
          MANIFEST

          cat > app/src/main/java/com/example/demo/MainActivity.java << 'JAVA'
          package com.example.demo;
          import android.app.Activity;
          import android.os.Bundle;
          public class MainActivity extends Activity {
              @Override
              protected void onCreate(Bundle savedInstanceState) {
                  super.onCreate(savedInstanceState);
                  setContentView(R.layout.activity_main);
              }
          }
          JAVA

          cat > app/src/main/res/layout/activity_main.xml << 'LAYOUT'
          <?xml version="1.0" encoding="utf-8"?>
          <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:layout_width="match_parent"
              android:layout_height="match_parent"
              android:gravity="center">
              <TextView
                  android:layout_width="wrap_content"
                  android:layout_height="wrap_content"
                  android:text="Template Ready"
                  android:textSize="24sp" />
          </LinearLayout>
          LAYOUT

          cat > app/src/main/res/values/strings.xml << 'STRINGS'
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <string name="app_name">Demo</string>
          </resources>
          STRINGS

          # 检查是否有变化
          if git diff --quiet; then
            echo "No changes to commit (already clean template)"
          else
            git add -A
            git commit -m "chore: reset to clean template [skip ci]"
            git push
            echo "Repository reset to clean template"
          fi
